# ëª©ì°¨
ğŸ€ [í”„ë¡œì ì…˜ê³¼ ê²°ê³¼ ë°˜í™˜ - ê¸°ë³¸](#í”„ë¡œì ì…˜ê³¼-ê²°ê³¼-ë°˜í™˜---ê¸°ë³¸)    
ğŸ€ [í”„ë¡œì ì…˜ê³¼ ê²°ê³¼ ë°˜í™˜ - DTO ì¡°íšŒ](#í”„ë¡œì ì…˜ê³¼-ê²°ê³¼-ë°˜í™˜---dto-ì¡°íšŒ)  
ğŸ€ [í”„ë¡œì ì…˜ê³¼ ê²°ê³¼ ë°˜í™˜ - @QueryProjection](#í”„ë¡œì ì…˜ê³¼-ê²°ê³¼-ë°˜í™˜---queryprojection)    
ğŸ€ [ë™ì  ì¿¼ë¦¬](#ë™ì -ì¿¼ë¦¬)    
ğŸ€ [ìˆ˜ì •, ì‚­ì œ ë²Œí¬ ì—°ì‚°](#ìˆ˜ì •-ì‚­ì œ-ë²Œí¬-ì—°ì‚°)  
ğŸ€ [SQL function í˜¸ì¶œí•˜ê¸°](#sql-function-í˜¸ì¶œí•˜ê¸°)

## í”„ë¡œì ì…˜ê³¼ ê²°ê³¼ ë°˜í™˜ - ê¸°ë³¸
í”„ë¡œì ì…˜: SELECT ì ˆì— ë¬´ì—‡ì„ ê°€ì ¸ì˜¬ì§€, ëŒ€ìƒì„ ì§€ì •í•˜ëŠ” ê²ƒ

### í”„ë¡œì ì…˜ ëŒ€ìƒì´ í•œ ê°œ ê²½ìš° - ëª…í™•í•œ íƒ€ì… ì§€ì •
```java
@Test
void simpleProjection() {
    List<String> result = queryFactory
            .select(member.username)
            .from(member)
            .fetch();
}
```

```java
@Test
void simpleProjection2() {
    List<Member> result = queryFactory
            .selectFrom(member)
            .fetch();
}
```
- í”„ë¡œì ì…˜ ëŒ€ìƒì´ í•œ ê°œ ì´ë©´, íƒ€ì…ì„ ëª…í™•í•˜ê²Œ ì§€ì •í•  ìˆ˜ ìˆë‹¤.
- í”„ë¡œì ì…˜ ëŒ€ìƒì´ ë‘ ê°œ ì´ìƒì´ë©´, íŠœí”Œì´ë‚˜ DTOë¡œ ì¡°íšŒí•´ì•¼ í•œë‹¤.

### í”„ë¡œì ì…˜ ëŒ€ìƒì´ ë‘˜ ì´ìƒì¸ ê²½ìš° - íŠœí”Œ ì¡°íšŒ
í”„ë¡œì ì…˜ ëŒ€ìƒì´ ë‘˜ ì´ìƒì¸ ê²½ìš°
```java
@Test
void tupleProjection() {
    List<Tuple> result = queryFactory
            .select(member.username, member.age)
            .from(member)
            .fetch();

    for (Tuple tuple : result) {
        String username = tuple.get(member.username);
        Integer age = tuple.get(member.age);
        System.out.println("username=" + username);
        System.out.println("age=" + age);
    }
}
```

> ğŸ€ Tupleì˜ íŒ¨í‚¤ì§€ëŠ” `com.querydsl.core` ì´ë‹¤.
> íŠœí”Œë¡œ ë°˜í™˜ëœ ê°’ì„ ì„œë¹„ìŠ¤ ê³„ì¸µê¹Œì§€ ë„˜ê²¨ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ì¢‹ì€ ì„¤ê³„ê°€ ì•„ë‹ˆë‹¤. ë ˆí¬ì§€í† ì—ì„œ DTOë¡œ ë°˜í™˜í•´ì„œ ë˜ì ¸ì£¼ì–´ì•¼ í•œë‹¤.

## ğŸ”¥ í”„ë¡œì ì…˜ê³¼ ê²°ê³¼ ë°˜í™˜ - DTO ì¡°íšŒ

### [MemberDTO](..%2Fsrc%2Fmain%2Fjava%2Fstudy%2Fquerydsl%2Fdto%2FMemberDTO.java) 
```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class MemberDTO {
    
    private String username;
    private int age;
    
}
```
### ìˆœìˆ˜ JPAì—ì„œ DTO ì¡°íšŒí•˜ê¸°
```java
@Test
void findDTOByJPQL() {
    List<MemberDTO> result = em.createQuery("SELECT NEW study.querydsl.dto.MemberDTO(m.username, m.age) FROM Member m", MemberDTO.class)
            .getResultList();
}
```
- ìˆœìˆ˜ JPAì—ì„œ DTOë¥¼ ì¡°íšŒí•  ë•ŒëŠ” `new` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
- DTOì˜ package ì´ë¦„ì„ ëª¨ë‘ ì ì–´ì¤˜ì•¼í•´ì„œ ì§€ì €ë¶„í•˜ë‹¤.
- ìƒì„±ì ë°©ì‹ë§Œ ì§€ì›í•œë‹¤. (**í•´ë‹¹ ë§¤ê°œë³€ìˆ˜ë§Œ ìˆëŠ” ìƒì„±ìê°€ í•„ìˆ˜ë¡œ í•„ìš”í•˜ë‹¤.**)

### QueryDSL Bean ìƒì„± (Bean population)
ê²°ê³¼ë¥¼ DTOë¡œ ë°˜í™˜í•  ë•Œ ì‚¬ìš©í•œë‹¤.  
ë‹¤ìŒ 3ê°€ì§€ ë°©ë²•ì„ ì§€ì›í•œë‹¤.
1. [í”„ë¡œí¼í‹° ì ‘ê·¼ (Setter)](#í”„ë¡œí¼í‹°-ì ‘ê·¼---setter)
2. [í•„ë“œ ì§ì ‘ ì ‘ê·¼](#í•„ë“œ-ì§ì ‘-ì ‘ê·¼)
3. [ìƒì„±ì ì‚¬ìš©](#ìƒì„±ì-ì‚¬ìš©)

#### í”„ë¡œí¼í‹° ì ‘ê·¼ - Setter
```java
@Test
void findDTOBySetter() {
    List<MemberDTO> result = queryFactory
            .select(Projections.bean(MemberDTO.class, member.username, member.age))
            .from(member)
            .fetch();
}
```
- ê¸°ë³¸ ìƒì„±ìë¡œ ê°ì²´ë¥¼ ìƒì„±í•˜ê³  Setterë¡œ ê°’ì„ ì£¼ì…í•œë‹¤. ê·¸ë˜ì„œ ê¸°ë³¸ ìƒì„±ìê°€ í•„ìˆ˜ë¡œ í•„ìš”í•˜ë‹¤.
- Getter()ë„ í•„ìˆ˜ë¡œ í•„ìš”í•˜ë‹¤.

#### í•„ë“œ ì§ì ‘ ì ‘ê·¼
```java
@Test
void findDTOByField() {
    List<MemberDTO> result = queryFactory
            .select(Projections.fields(MemberDTO.class, member.username, member.age))
            .from(member)
            .fetch();
}
```

#### í”„ë¡œí¼í‹° & í•„ë“œ ì ‘ê·¼ ìƒì„± ë°©ì‹ì—ì„œ ì´ë¦„ì´ ë‹¤ë¥¼ ê²½ìš°
```java
@Data
public class UserDTO {
    private String name;
    private int age;
}
```

```java
@Test
void findUserDTO() {
    queryFactory
            .select(Projections.fields(UserDTO.class, member.username.as("name"), member.age))
            .from(member)
            .fetch();
}
```

```java
@Test
void findUserDTO2() {
    queryFactory
            .select(Projections.fields(
                    UserDTO.class,
                    ExpressionUtils.as(member.username, "name"), 
                    member.age))
            .from(member)
            .fetch();
}
```
- ì¼ë°˜ ì¿¼ë¦¬ì¸ ê²½ìš° `findUserDTO1()`, `findUserDTO2()` ì²˜ëŸ¼ ëª¨ë‘ ì‚¬ìš©ê°€ëŠ¥í•˜ë‹¤.
- í•˜ì§€ë§Œ, `ExpressionUtils`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” `findUserDTO1()`ì´ ë” ì‚¬ìš©í•˜ê¸° ì‰½ê³  ì½ê¸°ì—ë„ ì‰½ë‹¤.

```java
@Test
void findUserDTO3() {
    QMember memberSub = new QMember("memberSub");
    
    queryFactory
            .select(Projections.fields(
                        UserDTO.class,
                        member.username.as("name"),
                        ExpressionUtils.as(JPAExpressions
                                .select(memberSub.age.max())
                                .from(memberSub), "age")
                    ))
            .from(member)
            .fetch();
}
```
- ì„œë¸Œ ì¿¼ë¦¬ì˜ ê²½ìš° `ExpressionUtils`ë¡œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.


- `ExpressionUtils.as(source, alias)`: í•„ë“œë‚˜ ì„œë¸Œ ì¿¼ë¦¬ì— ë³„ì¹­ ì ìš©
- `username.as("memberName")`: í•„ë“œì— ë³„ì¹­ ì ìš©

#### ìƒì„±ì ì‚¬ìš©
```java
@Test
void findDTOByConstructor() {
    queryFactory
            .select(Projections.constructor(MemberDTO.class, member.username, member.age))
            .from(member)
            .fetch();
}
```
- Entity ì»¬ëŸ¼ê³¼ DTO ì»¬ëŸ¼ì˜ íƒ€ì…ì´ ë™ì¼í•´ì•¼ í•œë‹¤.

## í”„ë¡œì ì…˜ê³¼ ê²°ê³¼ ë°˜í™˜ - @QueryProjection
### ìƒì„±ì + `@QueryProjection`
```java
@Data
@NoArgsConstructor
public class MemberDTO {

    private String username;
    private int age;

    @QueryProjection
    public MemberDTO(String username, int age) {
        this.username = username;
        this.age = age;
    }
}
```
- `/gradlew compileQuerydsl` or `/qeurydsl/Tasks/other/compile.java`
- `QMemberDto` ìƒì„± í™•ì¸

### @QueryProjection í™œìš©
```java
@Test
void findDTOByQueryProjection() {
    queryFactory
            .select(new QMemberDTO(member.username, member.age))
            .from(member)
            .fetch();
}
```
ì´ ë°©ë²•ì€ ì»´íŒŒì¼ëŸ¬ë¡œ íƒ€ì…ì„ ì²´í¬í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê°€ì¥ ì•ˆì „í•œ ë°©ë²•ì´ë‹¤.
ë‹¤ë§Œ DTOì— QueryDSL ì–´ë…¸í…Œì´ì…˜ì„ ìœ ì§€í•´ì•¼ í•˜ëŠ” ì ê³¼, DTOê¹Œì§€ Q íŒŒì¼ì„ ìƒì„±í•´ì•¼ í•˜ëŠ” ë‹¨ì ì´ ìˆë‹¤.  
ë˜, DTOê°€ QueryDSLì— ëŒ€í•œ ì˜ì¡´ì„±ì´ ìƒê¸´ë‹¤. (ì¶”í›„ì— QueryDSLì„ ì‚¬ìš©í•˜ì§€ ì•Šê²Œ ë˜ë©´ DTOë¥¼ ìˆ˜ì •í•´ì•¼ í•œë‹¤.)

### distinct
```java
@Test
void distinct() {
    queryFactory
            .select(member.username).distinct()
            .from(member)
            .fetch();
}
```
> ğŸ€ distinct ëŠ” JPQLì˜ distinct ì™€ ê°™ë‹¤.

## ë™ì  ì¿¼ë¦¬
ë™ì  ì¿¼ë¦¬ë¥¼ í•´ê²°í•˜ëŠ” ë‘ê°€ì§€ ë°©ì‹
- BooleanBuilder
- Where ë‹¤ì¤‘ íŒŒë¼ë¯¸í„° ì‚¬ìš©

### BooleanBuilder ì‚¬ìš©
```java
@Test
void ë™ì ì¿¼ë¦¬_BooleanBuilder() throws Exception {
    String usernameParam = "member1";

    Integer ageParam = 10;

    List<Member> result = searchMember1(usernameParam, ageParam);
    assertThat(result.size()).isEqualTo(1);
}

private List<Member> searchMember1(String usernameCond, Integer ageCond) {
    BooleanBuilder builder = new BooleanBuilder();

    if (usernameCond != null) {
        builder.and(member.username.eq(usernameCond));
    }

    if (ageCond != null) {
        builder.and(member.age.eq(ageCond));
    }

    return queryFactory
            .selectFrom(member)
            .where(builder)
            .fetch();
}
```



### ğŸ”¥ Where ë‹¤ì¤‘ íŒŒë¼ë¯¸í„° ì‚¬ìš©
```java
@Test
void ë™ì ì¿¼ë¦¬_WhereParam() throws Exception {
    String usernameParam = "member1";
    Integer ageParam = 10;

    List<Member> result = searchMember2(usernameParam, ageParam);
    assertThat(result.size()).isEqualTo(1);
}

private List<Member> searchMember2(String usernameCond, Integer ageCond) {
    return queryFactory
            .selectFrom(member)
            .where(usernameEq(usernameCond), ageEq(ageCond))
            .fetch();
}

private BooleanExpression usernameEq(String usernameCond) {
    return usernameCond != null ? member.username.eq(usernameCond) : null;
}

private BooleanExpression ageEq(Integer ageCond) {
    return ageCond != null ? member.age.eq(ageCond) : null;
}
```
- `where` ì¡°ê±´ì— `null` ê°’ì€ ë¬´ì‹œëœë‹¤.
- ë©”ì„œë“œë¥¼ ë‹¤ë¥¸ ì¿¼ë¦¬ì—ì„œë„ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
- ì¿¼ë¦¬ ìì²´ì˜ ê°€ë…ì„±ì´ ë†’ì•„ì§„ë‹¤.

#### ì¡°í•© ê°€ëŠ¥
```java
private BooleanExpression allEq(String usernameCond, Integer ageCond) {
    return usernameEq(usernameCond).and(ageEq(ageCond));
}
```
- `null` ì²´í¬ëŠ” ì£¼ì˜í•´ì„œ ì²˜ë¦¬í•´ì•¼ í•œë‹¤.

## ìˆ˜ì •, ì‚­ì œ ë²Œí¬ ì—°ì‚°
### ì¿¼ë¦¬ í•œ ë²ˆìœ¼ë¡œ ëŒ€ëŸ‰ ë°ì´í„° ìˆ˜ì •
```java
@Test
void ì¿¼ë¦¬_í•œ_ë²ˆìœ¼ë¡œ_ëŒ€ëŸ‰_ë°ì´í„°_ìˆ˜ì •() {
    long count = queryFactory
            .update(member)
            .set(member.username, "ë¹„íšŒì›")
            .where(member.age.lt(28))
            .execute();
}
```

### ë”í•˜ê¸°
```java
@Test
void ë”í•˜ê¸°() {
    queryFactory
            .update(member)
            .set(member.age, member.age.add(1))
            .execute();
}
```

### ê³±í•˜ê¸°
```java
@Test
void ê³±í•˜ê¸°() {
    queryFactory
            .update(member)
            .set(member.age, member.age.multiply(2))
            .execute();
}
```

### ì¿¼ë¦¬ í•œ ë²ˆìœ¼ë¡œ ëŒ€ëŸ‰ ë°ì´í„° ì‚­ì œ
```java
@Test
void ì¿¼ë¦¬_í•œ_ë²ˆìœ¼ë¡œ_ëŒ€ëŸ‰_ë°ì´í„°_ì‚­ì œ() {
    queryFactory
            .delete(member)
            .where(member.age.gt(18))
            .execute();
}
```

> ğŸš¨ JPQL ë°°ì¹˜ì™€ ë§ˆì°¬ê°€ì§€ë¡œ, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìˆëŠ” ì—”í‹°í‹°ë¥¼ ë¬´ì‹œí•˜ê³  ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì—
> ë°°ì¹˜ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê³  ë‚˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ê²ƒì´ ì•ˆì „í•˜ë‹¤.


## SQL function í˜¸ì¶œí•˜ê¸°