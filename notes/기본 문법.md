# ëª©ì°¨
ğŸ€ [JPQL vs QueryDSL](#jpql-vs-querydsl)  
ğŸ€ [Q-Type í™œìš©](#q-type-í™œìš©)  
ğŸ€ [ê²€ìƒ‰ ì¡°ê±´ ì¿¼ë¦¬](#ê²€ìƒ‰-ì¡°ê±´-ì¿¼ë¦¬)  
ğŸ€ [ê²°ê³¼ ì¡°íšŒ](#ê²°ê³¼-ì¡°íšŒ)  
ğŸ€ [ì •ë ¬](#ì •ë ¬)  
ğŸ€ [í˜ì´ì§•](#í˜ì´ì§•)  
ğŸ€ [ì§‘í•©](#ì§‘í•©)  
ğŸ€ [ì¡°ì¸ - ê¸°ë³¸ ì¡°ì¸](#ì¡°ì¸---ê¸°ë³¸-ì¡°ì¸)  
ğŸ€ [ì¡°ì¸ - ON ì ˆ](#ì¡°ì¸---on-ì ˆ)  
ğŸ€ [ì¡°ì¸ - Fetch Join](#ì¡°ì¸---fetch-join)  
ğŸ€ [ì„œë¸Œ ì¿¼ë¦¬](#ì„œë¸Œ-ì¿¼ë¦¬)  
ğŸ€ [Case ë¬¸](#case-ë¬¸)  
ğŸ€ [ìƒìˆ˜, ë¬¸ì ë”í•˜ê¸°](#ìƒìˆ˜-ë¬¸ì-ë”í•˜ê¸°)

## JPQL vs QueryDSL
### [í…ŒìŠ¤íŠ¸ ê¸°ë³¸ ì½”ë“œ - QueryDSLBasicTest](..%2Fsrc%2Ftest%2Fjava%2Fstudy%2Fquerydsl%2FQueryDSLBasicTest.java)
```java
@ActiveProfiles("test")
@SpringBootTest
@Transactional
public class QueryDSLBasicTest {
    
    @PersistenceContext
    EntityManager em;
    
    @BeforeEach
    public void before() {
        Team teamA = new Team("teamA");
        Team teamB = new Team("teamB");
        em.persist(teamA);
        em.persist(teamB);

        Member member1 = new Member("member1", 10, teamA);
        Member member2 = new Member("member2", 10, teamA);
        Member member3 = new Member("member3", 10, teamA);
        Member member4 = new Member("member4", 10, teamA);
        
        em.persist(member1);
        em.persist(member2);
        em.persist(member3);
        em.persist(member4);
    }
}
```

### `JPQL`ê³¼ `QueryDSL` ì½”ë“œ ë¹„êµ
#### [JPQL - QueryDSLBasicTest](..%2Fsrc%2Ftest%2Fjava%2Fstudy%2Fquerydsl%2FQueryDSLBasicTest.java)
```java
@Test
void startJPQL() {
    // member1 ì°¾ê¸°
    String qlString = "SELECT m FROM Member m WHERE m.username = :username";

    Member findMember = em.createQuery(qlString, Member.class)
            .setParameter("username", "member1")
            .getSingleResult();

    assertThat(findMember.getUsername()).isEqualTo("member1");
}
```

#### [QueryDSL - QueryDSLBasicTest](..%2Fsrc%2Ftest%2Fjava%2Fstudy%2Fquerydsl%2FQueryDSLBasicTest.java) 
```java
@Test
void startQueryDSL() {
    // member1 ì°¾ê¸°
    JPAQueryFactory queryFactory = new JPAQueryFactory(em);
    QMember m = new QMember("m");

    Member findMember = queryFactory
            .select(m)
            .from(m)
            .where(m.username.eq("member1")) // íŒŒë¼ë¯¸í„° ë°”ì¸ë”© ì²˜ë¦¬
            .fetchOne();

    assertThat(findMember.getUsername()).isEqualTo("member1");
}
```
- `EntityManager`ë¡œ `JPAQueryFactory` ìƒì„±
- QueryDSLì€ JPQL ë¹Œë”
- 
|          | JPQL     | QueryDSL  |
|----------|----------|-----------|
| ì˜¤ë¥˜ ìœ í˜•    | ì‹¤í–‰ ì‹œì  ì˜¤ë¥˜ | ì»´íŒŒì¼ ì‹œì  ì˜¤ë¥˜ |
| íŒŒë¼ë¯¸í„° ë°”ì¸ë”© | ì§ì ‘ì ìœ¼ë¡œ ì²˜ë¦¬ | ìë™ìœ¼ë¡œ ì²˜ë¦¬   |

### JPAQueryFactoryë¥¼ í•„ë“œë¡œ
```java
@ActiveProfiles("test")
@SpringBootTest
@Transactional
public class QueryDSLBasicTest {

    @PersistenceContext
    EntityManager em;

    JPAQueryFactory queryFactory;

    @BeforeEach
    void before() {
        queryFactory = new JPAQueryFactory(em);
        
        // ... 
    }
    
    @Test
    void startQueryDSL2() {
        // member1 ì°¾ê¸°
        QMember m = new QMember("m");

        Member findMember = queryFactory
                .select(m)
                .from(m)
                .where(m.username.eq("member1"))
                .fetchOne();

        assertThat(findMember.getUsername()).isEqualTo("member1");
    }

}
```
JPAQueryFactoryë¥¼ í•„ë“œë¡œ ì œê³µí•˜ë©´ ë™ì‹œì„± ë¬¸ì œëŠ” ì–´ë–»ê²Œ ë ê¹Œ?  
ë™ì‹œì„± ë¬¸ì œëŠ” JPAQueryFactoryë¥¼ ìƒì„±í•  ë•Œ ì œê³µí•˜ëŠ” EntityManager(em)ì— ë‹¬ë ¤ìˆë‹¤.
ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ëŠ” ì—¬ëŸ¬ ì“°ë ˆë“œì—ì„œ ë™ì‹œì— ê°™ì€ EntityManagerì— ì ‘ê·¼í•´ë„,
íŠ¸ëœì­ì…˜ ë§ˆë‹¤ ë³„ë„ì˜ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì œê³µí•˜ê¸° ë•Œë¬¸ì—, ë™ì‹œì„± ë¬¸ì œëŠ” ê±±ì •í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

## Q-Type í™œìš©
### Qí´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” 2ê°€ì§€ ë°©ë²•
1. ë³„ì¹­ ì§ì ‘ ì§€ì •
    ```java
    QMember qMember = new QMember("m");
    ```
2. ê¸°ë³¸ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©
    ```java
    QMember qMember = QMember.member;
    ```
   
### ğŸš¨ [ê¸°ë³¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ static importì™€ í•¨ê»˜ ì‚¬ìš© - QueryDSLBasicTest](..%2Fsrc%2Ftest%2Fjava%2Fstudy%2Fquerydsl%2FQueryDSLBasicTest.java)
```java
// ..
import static study.querydsl.entity.QMember.member;

@ActiveProfiles("test")
@SpringBootTest
@Transactional
public class QueryDSLBasicTest {

    // ...
    
    @Test
    void startQueryDSL3() {
        // member1 ì°¾ê¸°
        Member findMember = queryFactory
                .select(member)
                .from(member)
                .where(member.username.eq("member1"))
                .fetchOne();

        assertThat(findMember.getUsername()).isEqualTo("member1");
    }

}
```

### ë¡œê·¸ì—ì„œ ì‹¤í–‰ë˜ëŠ” JPQLì„ í™•ì¸í•˜ê¸° ìœ„í•œ ì„¤ì •
ë‹¤ìŒ ì„¤ì •ì„ ì¶”ê°€í•˜ë©´ ì‹¤í–‰ë˜ëŠ” JPQLì„ ë³¼ ìˆ˜ ìˆë‹¤.
```yaml
spring:
  jpa:
    properties:
      hibernate:
        use_sql_comments: true
```
> ğŸ€ **ê°™ì€ í…Œì´ë¸”ì„ ì¡°ì¸í•´ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ì•„ë‹ˆë©´ ê¸°ë³¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì!**

## ê²€ìƒ‰ ì¡°ê±´ ì¿¼ë¦¬
### ê¸°ë³¸ ê²€ìƒ‰ ì¿¼ë¦¬
```java
@Test
void search() {
     Member findMember = queryFactory
             .selectFrom(member)
             .where(member.username.eq("member1")
                     .and(member.age.eq(10)))
             .fetchOne();
   
     assertThat(findMember.getUsername()).isEqualTo("member1");
}
```
- ê²€ìƒ‰ ì¡°ê±´ì€ `.and()`, `.or()`ë¥¼ ë©”ì„œë“œ ì²´ì¸ìœ¼ë¡œ ì—°ê²°í•  ìˆ˜ ìˆë‹¤.
> ğŸ€ `select()`ì™€ `from()`ì„ `selectFrom()`ìœ¼ë¡œ í•©ì¹  ìˆ˜ ìˆë‹¤.

### JPQLì´ ì œê³µí•˜ëŠ” ëª¨ë“  ê²€ìƒ‰ ì¡°ê±´ì„ ì œê³µí•œë‹¤.
| QueryDSL ë©”ì†Œë“œ                         | JPQL í‘œí˜„ì‹              |
|--------------------------------------|-----------------------|
| member.username.eq("member1")        | username = 'member1'  |
| member.username.ne("member1")        | username != 'member1' |
| member.username.eq("member1").not()  | username != 'member1' |
| member.username.isNotNull()          | username != null      |
| member.age.in(10, 20)                | age in (10,20)        |
| member.age.notIn(10, 20)             | age not in (10, 20)   |
| member.age.between(10,30)            | between 10 and 30     |
| member.age.goe(30)                   | age >= 30             |
| member.age.gt(30)                    | age > 30              |
| member.age.loe(30)                   | age <= 30             |
| member.age.lt(30)                    | age < 30              |
| member.username.like("member%")      | like 'member%'        |
| member.username.contains("member")   | like '%member%'       |
| member.username.startsWith("member") | like 'member%'        |


### AND ì¡°ê±´ì„ íŒŒë¼ë¯¸í„°ë¡œ ì²˜ë¦¬
```java
@Test
void searchAndParam() {
    List<Member> result1 = queryFactory
            .selectFrom(member)
            .where(member.username.eq("member1"), member.age.eq(10))
            .fetch();

    assertThat(result1.size()).isEqualTo(1);
}
```

- `where()`ì— íŒŒë¼ë¯¸í„°ë¡œ ê²€ìƒ‰ì¡°ê±´ì„ ì¶”ê°€í•˜ë©´ `AND` ì¡°ê±´ì´ ì¶”ê°€ëœë‹¤.  
- ì´ ê²½ìš° `null` ê°’ì€ ë¬´ì‹œ í•œë‹¤. â¡ï¸ ë©”ì„œë“œ ì¶”ì¶œì„ í™œìš©í•´ì„œ ë™ì  ì¿¼ë¦¬ë¥¼ ê¹”ë”í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤. â¡ï¸ ë’¤ì—ì„œ ì„¤ëª…!

## ê²°ê³¼ ì¡°íšŒ
| ë©”ì†Œë“œ              | ì„¤ëª…                                                         |
|------------------|------------------------------------------------------------|
| `fetch()`        | ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ, ë°ì´í„° ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜                                   |
| `fetchOne()`     | ë‹¨ ê±´ ì¡°íšŒ                                                     |
|                  | - ê²°ê³¼ê°€ ì—†ìœ¼ë©´: `null`                                          |
|                  | - ê²°ê³¼ê°€ ë‘˜ ì´ìƒì´ë©´: `com.querydsl.core.NonUniqueResultException` |
| `fetchFirst()`   | `limit(1).fetchOne()`                                      |
| `fetchResults()` | í˜ì´ì§• ì •ë³´ í¬í•¨, total count ì¿¼ë¦¬ ì¶”ê°€ ì‹¤í–‰                            |
| `fetchCount()`   | count ì¿¼ë¦¬ë¡œ ë³€ê²½í•´ì„œ count ìˆ˜ ì¡°íšŒ                                  |

### List
```java
List<Member> fetch = queryFactory
        .selectFrom(member)
        .fetch();
```

### ë‹¨ ê±´
```java
Member findMember1 = queryFactory
        .selectFrom(member)
        .fetchOne();
```

### ì¡°íšŒëœ ì²« ë²ˆì§¸ ê±´
```java
Member findMember2 = queryFactory
        .selectFrom(member)
        .fetchFirst();
```

### í˜ì´ì§•ì—ì„œ ì‚¬ìš©
```java
QueryResults<Member> results = queryFactory
        .selectFrom(member)
        .fetchResults();
```

### count ì¿¼ë¦¬ë¡œ ë³€ê²½
```java
long count = queryFactory
        .selectFrom(member)
        .fetchCount();
```

## ì •ë ¬
| ë©”ì†Œë“œ            | ì„¤ëª…             |
|----------------|----------------|
| `desc()`       | ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬        |
| `asc()`        | ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬        |
| `nullsLast()`  | null ë°ì´í„°ëŠ” ë§ˆì§€ë§‰ì— |
| `nullsFirst()` | null ë°ì´í„°ëŠ” ë§¨ ì•ì— |

### ì‚¬ìš© ì˜ˆì‹œ
```java
/**
 * íšŒì› ì •ë ¬ ìˆœì„œ
 * 1. íšŒì› ë‚˜ì´ ë‚´ë¦¼ì°¨ìˆœ(desc)
 * 2. íšŒì› ì´ë¦„ ì˜¬ë¦¼ì°¨ìˆœ(asc)
 * ë‹¨, 2ì—ì„œ íšŒì› ì´ë¦„ì´ ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ì— ì¶œë ¥(nulls last)
 */
@Test
void sort() {
    em.persist(new Member(null, 100));
    em.persist(new Member("member5", 100));
    em.persist(new Member("member6", 100));

    List<Member> result = queryFactory
            .selectFrom(member)
            .where(member.age.eq(100))
            .orderBy(member.age.desc(), member.username.asc().nullsLast())
            .fetch();

    Member member5 = result.get(0);
    Member member6 = result.get(1);
    Member memberNull = result.get(2);

    assertThat(member5.getUsername()).isEqualTo("member5");
    assertThat(member6.getUsername()).isEqualTo("member6");
    assertThat(memberNull.getUsername()).isNull();
}
```

## í˜ì´ì§•
### ì¡°íšŒ ê±´ìˆ˜ ì œí•œ
```java
@Test
void paging1() {
    List<Member> result = queryFactory
            .selectFrom(member)
            .orderBy(member.username.desc())
            .offset(1)
            .limit(2)
            .fetch();

    assertThat(result.size()).isEqualTo(2);
}
```

### ì „ì²´ ì¡°íšŒ ìˆ˜
```java
@Test
void paging2() {
    QueryResults<Member> queryResults = queryFactory
            .selectFrom(member)
            .orderBy(member.username.desc())
            .offset(1)
            .limit(2)
            .fetchResults();

    assertThat(queryResults.getTotal()).isEqualTo(4);
    assertThat(queryResults.getLimit()).isEqualTo(2);
    assertThat(queryResults.getOffset()).isEqualTo(1);
    assertThat(queryResults.getResults().size()).isEqualTo(2);
}
```

> ğŸš¨ count ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— ì£¼ì˜í•´ì•¼ í•œë‹¤.

> ğŸ€ ì‹¤ë¬´ì—ì„œ í˜ì´ì§• ì¿¼ë¦¬ë¥¼ ì‘ì„±í•  ë•Œ, ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ëŠ” ì—¬ëŸ¬ í…Œì´ë¸”ì„ ì¡°ì¸í•´ì•¼ í•˜ì§€ë§Œ, 
> count ì¿¼ë¦¬ëŠ” ì¡°ì¸ì´ í•„ìš”ì—†ëŠ” ê²½ìš°ë„ ìˆë‹¤.
> ê·¸ëŸ°ë° ì´ë ‡ê²Œ ìë™í™”ëœ count ì¿¼ë¦¬ëŠ” ì›ë³¸ ì¿¼ë¦¬ì™€ ëª¨ë‘ ì¡°ì¸ì„ í•´ë²„ë¦¬ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì´ ì•ˆë‚˜ì˜¬ ìˆ˜ë„ ìˆë‹¤.
> count ì¿¼ë¦¬ì— ì¡°ì¸ì´ í•„ìš”ì—†ëŠ” ì„±ëŠ¥ ìµœì í•˜ê°€ í•„ìš”í•˜ë‹¤ë©´,  **count ì „ìš© ì¿¼ë¦¬ë¥¼ ë³„ë„ë¡œ ì‘ì„±í•´ì•¼ í•œë‹¤.**

## ì§‘í•©
| í•¨ìˆ˜           | ì„¤ëª…    |
|--------------|-------|
| `COUNT(m)`   | íšŒì› ìˆ˜  |
| `SUM(m.age)` | ë‚˜ì´ í•©  |
| `AVG(m.age)` | í‰ê·  ë‚˜ì´ |
| `MAX(m.age)` | ìµœëŒ€ ë‚˜ì´ |
| `MIN(m.age)` | ìµœì†Œ ë‚˜ì´ |

```java
@Test
void aggregation() throws Exception {
    List<Tuple> result = queryFactory
            .select(member.count(),
                    member.age.sum(),
                    member.age.avg(),
                    member.age.max(),
                    member.age.min())
            .from(member)
            .fetch();

    Tuple tuple = result.get(0);

    assertThat(tuple.get(member.count())).isEqualTo(4);
    assertThat(tuple.get(member.age.sum())).isEqualTo(100);
    assertThat(tuple.get(member.age.avg())).isEqualTo(25);
    assertThat(tuple.get(member.age.max())).isEqualTo(40);
    assertThat(tuple.get(member.age.min())).isEqualTo(10);
}
```
- `JPQL`ì´ ì œê³µí•˜ëŠ” ëª¨ë“  ì§‘í•© í•¨ìˆ˜ë¥¼ ì œê³µí•œë‹¤.
- tupleì€ í”„ë¡œì ì…˜ê³¼ ê²°ê³¼ë°˜í™˜ì—ì„œ ì„¤ëª…í•œë‹¤.

### `GroupBy` ì‚¬ìš©
```java
/**
 * íŒ€ì˜ ì´ë¦„ê³¼ ê° íŒ€ì˜ í‰ê·  ì—°ë ¹ êµ¬í•˜ê¸°.
 */
@Test
void group() throws Exception {
    List<Tuple> result = queryFactory
            .select(team.name, member.age.avg())
            .from(member)
            .join(member.team, team)
            .groupBy(team.name)
            .fetch();

    Tuple teamA = result.get(0);
    Tuple teamB = result.get(1);

    assertThat(teamA.get(team.name)).isEqualTo("teamA");
    assertThat(teamA.get(member.age.avg())).isEqualTo(15);
    assertThat(teamB.get(team.name)).isEqualTo("teamB");
    assertThat(teamB.get(member.age.avg())).isEqualTo(35);
}
```
ê·¸ë£¹í™”ëœ ê²°ê³¼ë¥¼ ì œí•œí•˜ë ¤ë©´ `having()`ì„ ì‚¬ìš©í•  ê²ƒ.

### `groupBy()`, `having()` ì˜ˆì‹œ
```text
.groupBy(item.price)
.having(item.price.gt(1_000))
```

## ì¡°ì¸ - ê¸°ë³¸ ì¡°ì¸
## ì¡°ì¸ - ON ì ˆ
## ì¡°ì¸ - Fetch Join
## ì„œë¸Œ ì¿¼ë¦¬
## Case ë¬¸
## ìƒìˆ˜, ë¬¸ì ë”í•˜ê¸°