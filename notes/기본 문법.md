# ëª©ì°¨
ğŸ€ [JPQL vs QueryDSL](#jpql-vs-querydsl)  
ğŸ€ [Q-Type í™œìš©](#q-type-í™œìš©)  
ğŸ€ [ê²€ìƒ‰ ì¡°ê±´ ì¿¼ë¦¬](#ê²€ìƒ‰-ì¡°ê±´-ì¿¼ë¦¬)  
ğŸ€ [ê²°ê³¼ ì¡°íšŒ](#ê²°ê³¼-ì¡°íšŒ)  
ğŸ€ [ì •ë ¬](#ì •ë ¬)  
ğŸ€ [í˜ì´ì§•](#í˜ì´ì§•)  
ğŸ€ [ì§‘í•©](#ì§‘í•©)  
ğŸ€ [ì¡°ì¸ - ê¸°ë³¸ ì¡°ì¸](#ì¡°ì¸---ê¸°ë³¸-ì¡°ì¸)  
ğŸ€ [ì¡°ì¸ - ON ì ˆ](#ì¡°ì¸---on-ì ˆ)  
ğŸ€ [ì¡°ì¸ - Fetch Join](#ì¡°ì¸---fetch-join)  
ğŸ€ [ì„œë¸Œ ì¿¼ë¦¬](#ì„œë¸Œ-ì¿¼ë¦¬)  
ğŸ€ [Case ë¬¸](#case-ë¬¸)  
ğŸ€ [ìƒìˆ˜, ë¬¸ì ë”í•˜ê¸°](#ìƒìˆ˜-ë¬¸ì-ë”í•˜ê¸°)

## JPQL vs QueryDSL
### [í…ŒìŠ¤íŠ¸ ê¸°ë³¸ ì½”ë“œ - QueryDSLBasicTest](..%2Fsrc%2Ftest%2Fjava%2Fstudy%2Fquerydsl%2FQueryDSLBasicTest.java)
```java
@ActiveProfiles("test")
@SpringBootTest
@Transactional
public class QueryDSLBasicTest {
    
    @PersistenceContext
    EntityManager em;
    
    @BeforeEach
    public void before() {
        Team teamA = new Team("teamA");
        Team teamB = new Team("teamB");
        em.persist(teamA);
        em.persist(teamB);

        Member member1 = new Member("member1", 10, teamA);
        Member member2 = new Member("member2", 10, teamA);
        Member member3 = new Member("member3", 10, teamA);
        Member member4 = new Member("member4", 10, teamA);
        
        em.persist(member1);
        em.persist(member2);
        em.persist(member3);
        em.persist(member4);
    }
}
```

### `JPQL`ê³¼ `QueryDSL` ì½”ë“œ ë¹„êµ
#### [JPQL - QueryDSLBasicTest](..%2Fsrc%2Ftest%2Fjava%2Fstudy%2Fquerydsl%2FQueryDSLBasicTest.java)
```java
@Test
void startJPQL() {
    // member1 ì°¾ê¸°
    String qlString = "SELECT m FROM Member m WHERE m.username = :username";

    Member findMember = em.createQuery(qlString, Member.class)
            .setParameter("username", "member1")
            .getSingleResult();

    assertThat(findMember.getUsername()).isEqualTo("member1");
}
```

#### [QueryDSL - QueryDSLBasicTest](..%2Fsrc%2Ftest%2Fjava%2Fstudy%2Fquerydsl%2FQueryDSLBasicTest.java) 
```java
@Test
void startQueryDSL() {
    // member1 ì°¾ê¸°
    JPAQueryFactory queryFactory = new JPAQueryFactory(em);
    QMember m = new QMember("m");

    Member findMember = queryFactory
            .select(m)
            .from(m)
            .where(m.username.eq("member1")) // íŒŒë¼ë¯¸í„° ë°”ì¸ë”© ì²˜ë¦¬
            .fetchOne();

    assertThat(findMember.getUsername()).isEqualTo("member1");
}
```
- `EntityManager`ë¡œ `JPAQueryFactory` ìƒì„±
- QueryDSLì€ JPQL ë¹Œë”
- 
|          | JPQL     | QueryDSL  |
|----------|----------|-----------|
| ì˜¤ë¥˜ ìœ í˜•    | ì‹¤í–‰ ì‹œì  ì˜¤ë¥˜ | ì»´íŒŒì¼ ì‹œì  ì˜¤ë¥˜ |
| íŒŒë¼ë¯¸í„° ë°”ì¸ë”© | ì§ì ‘ì ìœ¼ë¡œ ì²˜ë¦¬ | ìë™ìœ¼ë¡œ ì²˜ë¦¬   |

### JPAQueryFactoryë¥¼ í•„ë“œë¡œ
```java
@ActiveProfiles("test")
@SpringBootTest
@Transactional
public class QueryDSLBasicTest {

    @PersistenceContext
    EntityManager em;

    JPAQueryFactory queryFactory;

    @BeforeEach
    void before() {
        queryFactory = new JPAQueryFactory(em);
        
        // ... 
    }
    
    @Test
    void startQueryDSL2() {
        // member1 ì°¾ê¸°
        QMember m = new QMember("m");

        Member findMember = queryFactory
                .select(m)
                .from(m)
                .where(m.username.eq("member1"))
                .fetchOne();

        assertThat(findMember.getUsername()).isEqualTo("member1");
    }

}
```
JPAQueryFactoryë¥¼ í•„ë“œë¡œ ì œê³µí•˜ë©´ ë™ì‹œì„± ë¬¸ì œëŠ” ì–´ë–»ê²Œ ë ê¹Œ?  
ë™ì‹œì„± ë¬¸ì œëŠ” JPAQueryFactoryë¥¼ ìƒì„±í•  ë•Œ ì œê³µí•˜ëŠ” EntityManager(em)ì— ë‹¬ë ¤ìˆë‹¤.
ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ëŠ” ì—¬ëŸ¬ ì“°ë ˆë“œì—ì„œ ë™ì‹œì— ê°™ì€ EntityManagerì— ì ‘ê·¼í•´ë„,
íŠ¸ëœì­ì…˜ ë§ˆë‹¤ ë³„ë„ì˜ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì œê³µí•˜ê¸° ë•Œë¬¸ì—, ë™ì‹œì„± ë¬¸ì œëŠ” ê±±ì •í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

## Q-Type í™œìš©
### Qí´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” 2ê°€ì§€ ë°©ë²•
1. ë³„ì¹­ ì§ì ‘ ì§€ì •
    ```java
    QMember qMember = new QMember("m");
    ```
2. ê¸°ë³¸ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©
    ```java
    QMember qMember = QMember.member;
    ```
   
### ğŸš¨ [ê¸°ë³¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ static importì™€ í•¨ê»˜ ì‚¬ìš© - QueryDSLBasicTest](..%2Fsrc%2Ftest%2Fjava%2Fstudy%2Fquerydsl%2FQueryDSLBasicTest.java)
```java
// ..
import static study.querydsl.entity.QMember.member;

@ActiveProfiles("test")
@SpringBootTest
@Transactional
public class QueryDSLBasicTest {

    // ...
    
    @Test
    void startQueryDSL3() {
        // member1 ì°¾ê¸°
        Member findMember = queryFactory
                .select(member)
                .from(member)
                .where(member.username.eq("member1"))
                .fetchOne();

        assertThat(findMember.getUsername()).isEqualTo("member1");
    }

}
```

### ë¡œê·¸ì—ì„œ ì‹¤í–‰ë˜ëŠ” JPQLì„ í™•ì¸í•˜ê¸° ìœ„í•œ ì„¤ì •
ë‹¤ìŒ ì„¤ì •ì„ ì¶”ê°€í•˜ë©´ ì‹¤í–‰ë˜ëŠ” JPQLì„ ë³¼ ìˆ˜ ìˆë‹¤.
```yaml
spring:
  jpa:
    properties:
      hibernate:
        use_sql_comments: true
```
> ğŸ€ **ê°™ì€ í…Œì´ë¸”ì„ ì¡°ì¸í•´ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ì•„ë‹ˆë©´ ê¸°ë³¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì!**

## ê²€ìƒ‰ ì¡°ê±´ ì¿¼ë¦¬
### ê¸°ë³¸ ê²€ìƒ‰ ì¿¼ë¦¬
```java
@Test
void search() {
     Member findMember = queryFactory
             .selectFrom(member)
             .where(member.username.eq("member1")
                     .and(member.age.eq(10)))
             .fetchOne();
   
     assertThat(findMember.getUsername()).isEqualTo("member1");
}
```
- ê²€ìƒ‰ ì¡°ê±´ì€ `.and()`, `.or()`ë¥¼ ë©”ì„œë“œ ì²´ì¸ìœ¼ë¡œ ì—°ê²°í•  ìˆ˜ ìˆë‹¤.
> ğŸ€ `select()`ì™€ `from()`ì„ `selectFrom()`ìœ¼ë¡œ í•©ì¹  ìˆ˜ ìˆë‹¤.

### JPQLì´ ì œê³µí•˜ëŠ” ëª¨ë“  ê²€ìƒ‰ ì¡°ê±´ì„ ì œê³µí•œë‹¤.
| QueryDSL ë©”ì†Œë“œ                         | JPQL í‘œí˜„ì‹              |
|--------------------------------------|-----------------------|
| member.username.eq("member1")        | username = 'member1'  |
| member.username.ne("member1")        | username != 'member1' |
| member.username.eq("member1").not()  | username != 'member1' |
| member.username.isNotNull()          | username != null      |
| member.age.in(10, 20)                | age in (10,20)        |
| member.age.notIn(10, 20)             | age not in (10, 20)   |
| member.age.between(10,30)            | between 10 and 30     |
| member.age.goe(30)                   | age >= 30             |
| member.age.gt(30)                    | age > 30              |
| member.age.loe(30)                   | age <= 30             |
| member.age.lt(30)                    | age < 30              |
| member.username.like("member%")      | like 'member%'        |
| member.username.contains("member")   | like '%member%'       |
| member.username.startsWith("member") | like 'member%'        |


### AND ì¡°ê±´ì„ íŒŒë¼ë¯¸í„°ë¡œ ì²˜ë¦¬
```java
@Test
void searchAndParam() {
    List<Member> result1 = queryFactory
            .selectFrom(member)
            .where(member.username.eq("member1"), member.age.eq(10))
            .fetch();

    assertThat(result1.size()).isEqualTo(1);
}
```

- `where()`ì— íŒŒë¼ë¯¸í„°ë¡œ ê²€ìƒ‰ì¡°ê±´ì„ ì¶”ê°€í•˜ë©´ `AND` ì¡°ê±´ì´ ì¶”ê°€ëœë‹¤.  
- ì´ ê²½ìš° `null` ê°’ì€ ë¬´ì‹œ í•œë‹¤. â¡ï¸ ë©”ì„œë“œ ì¶”ì¶œì„ í™œìš©í•´ì„œ ë™ì  ì¿¼ë¦¬ë¥¼ ê¹”ë”í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤. â¡ï¸ ë’¤ì—ì„œ ì„¤ëª…!

## ê²°ê³¼ ì¡°íšŒ
| ë©”ì†Œë“œ              | ì„¤ëª…                                                         |
|------------------|------------------------------------------------------------|
| `fetch()`        | ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ, ë°ì´í„° ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜                                   |
| `fetchOne()`     | ë‹¨ ê±´ ì¡°íšŒ                                                     |
|                  | - ê²°ê³¼ê°€ ì—†ìœ¼ë©´: `null`                                          |
|                  | - ê²°ê³¼ê°€ ë‘˜ ì´ìƒì´ë©´: `com.querydsl.core.NonUniqueResultException` |
| `fetchFirst()`   | `limit(1).fetchOne()`                                      |
| `fetchResults()` | í˜ì´ì§• ì •ë³´ í¬í•¨, total count ì¿¼ë¦¬ ì¶”ê°€ ì‹¤í–‰                            |
| `fetchCount()`   | count ì¿¼ë¦¬ë¡œ ë³€ê²½í•´ì„œ count ìˆ˜ ì¡°íšŒ                                  |

### List
```java
List<Member> fetch = queryFactory
        .selectFrom(member)
        .fetch();
```

### ë‹¨ ê±´
```java
Member findMember1 = queryFactory
        .selectFrom(member)
        .fetchOne();
```

### ì¡°íšŒëœ ì²« ë²ˆì§¸ ê±´
```java
Member findMember2 = queryFactory
        .selectFrom(member)
        .fetchFirst();
```

### í˜ì´ì§•ì—ì„œ ì‚¬ìš©
```java
QueryResults<Member> results = queryFactory
        .selectFrom(member)
        .fetchResults();
```

### count ì¿¼ë¦¬ë¡œ ë³€ê²½
```java
long count = queryFactory
        .selectFrom(member)
        .fetchCount();
```

## ì •ë ¬
| ë©”ì†Œë“œ            | ì„¤ëª…             |
|----------------|----------------|
| `desc()`       | ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬        |
| `asc()`        | ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬        |
| `nullsLast()`  | null ë°ì´í„°ëŠ” ë§ˆì§€ë§‰ì— |
| `nullsFirst()` | null ë°ì´í„°ëŠ” ë§¨ ì•ì— |

### ì‚¬ìš© ì˜ˆì‹œ
```java
/**
 * íšŒì› ì •ë ¬ ìˆœì„œ
 * 1. íšŒì› ë‚˜ì´ ë‚´ë¦¼ì°¨ìˆœ(desc)
 * 2. íšŒì› ì´ë¦„ ì˜¬ë¦¼ì°¨ìˆœ(asc)
 * ë‹¨, 2ì—ì„œ íšŒì› ì´ë¦„ì´ ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ì— ì¶œë ¥(nulls last)
 */
@Test
void sort() {
    em.persist(new Member(null, 100));
    em.persist(new Member("member5", 100));
    em.persist(new Member("member6", 100));

    List<Member> result = queryFactory
            .selectFrom(member)
            .where(member.age.eq(100))
            .orderBy(member.age.desc(), member.username.asc().nullsLast())
            .fetch();

    Member member5 = result.get(0);
    Member member6 = result.get(1);
    Member memberNull = result.get(2);

    assertThat(member5.getUsername()).isEqualTo("member5");
    assertThat(member6.getUsername()).isEqualTo("member6");
    assertThat(memberNull.getUsername()).isNull();
}
```

## í˜ì´ì§•
### ì¡°íšŒ ê±´ìˆ˜ ì œí•œ
```java
@Test
void paging1() {
    List<Member> result = queryFactory
            .selectFrom(member)
            .orderBy(member.username.desc())
            .offset(1)
            .limit(2)
            .fetch();

    assertThat(result.size()).isEqualTo(2);
}
```

### ì „ì²´ ì¡°íšŒ ìˆ˜
```java
@Test
void paging2() {
    QueryResults<Member> queryResults = queryFactory
            .selectFrom(member)
            .orderBy(member.username.desc())
            .offset(1)
            .limit(2)
            .fetchResults();

    assertThat(queryResults.getTotal()).isEqualTo(4);
    assertThat(queryResults.getLimit()).isEqualTo(2);
    assertThat(queryResults.getOffset()).isEqualTo(1);
    assertThat(queryResults.getResults().size()).isEqualTo(2);
}
```

> ğŸš¨ count ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— ì£¼ì˜í•´ì•¼ í•œë‹¤.

> ğŸ€ ì‹¤ë¬´ì—ì„œ í˜ì´ì§• ì¿¼ë¦¬ë¥¼ ì‘ì„±í•  ë•Œ, ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ëŠ” ì—¬ëŸ¬ í…Œì´ë¸”ì„ ì¡°ì¸í•´ì•¼ í•˜ì§€ë§Œ, 
> count ì¿¼ë¦¬ëŠ” ì¡°ì¸ì´ í•„ìš”ì—†ëŠ” ê²½ìš°ë„ ìˆë‹¤.
> ê·¸ëŸ°ë° ì´ë ‡ê²Œ ìë™í™”ëœ count ì¿¼ë¦¬ëŠ” ì›ë³¸ ì¿¼ë¦¬ì™€ ëª¨ë‘ ì¡°ì¸ì„ í•´ë²„ë¦¬ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì´ ì•ˆë‚˜ì˜¬ ìˆ˜ë„ ìˆë‹¤.
> count ì¿¼ë¦¬ì— ì¡°ì¸ì´ í•„ìš”ì—†ëŠ” ì„±ëŠ¥ ìµœì í•˜ê°€ í•„ìš”í•˜ë‹¤ë©´,  **count ì „ìš© ì¿¼ë¦¬ë¥¼ ë³„ë„ë¡œ ì‘ì„±í•´ì•¼ í•œë‹¤.**

## ì§‘í•©
| í•¨ìˆ˜           | ì„¤ëª…    |
|--------------|-------|
| `COUNT(m)`   | íšŒì› ìˆ˜  |
| `SUM(m.age)` | ë‚˜ì´ í•©  |
| `AVG(m.age)` | í‰ê·  ë‚˜ì´ |
| `MAX(m.age)` | ìµœëŒ€ ë‚˜ì´ |
| `MIN(m.age)` | ìµœì†Œ ë‚˜ì´ |

```java
@Test
void aggregation() throws Exception {
    List<Tuple> result = queryFactory
            .select(member.count(),
                    member.age.sum(),
                    member.age.avg(),
                    member.age.max(),
                    member.age.min())
            .from(member)
            .fetch();

    Tuple tuple = result.get(0);

    assertThat(tuple.get(member.count())).isEqualTo(4);
    assertThat(tuple.get(member.age.sum())).isEqualTo(100);
    assertThat(tuple.get(member.age.avg())).isEqualTo(25);
    assertThat(tuple.get(member.age.max())).isEqualTo(40);
    assertThat(tuple.get(member.age.min())).isEqualTo(10);
}
```
- `JPQL`ì´ ì œê³µí•˜ëŠ” ëª¨ë“  ì§‘í•© í•¨ìˆ˜ë¥¼ ì œê³µí•œë‹¤.
- tupleì€ í”„ë¡œì ì…˜ê³¼ ê²°ê³¼ë°˜í™˜ì—ì„œ ì„¤ëª…í•œë‹¤.

### `GroupBy` ì‚¬ìš©
```java
/**
 * íŒ€ì˜ ì´ë¦„ê³¼ ê° íŒ€ì˜ í‰ê·  ì—°ë ¹ êµ¬í•˜ê¸°.
 */
@Test
void group() throws Exception {
    List<Tuple> result = queryFactory
            .select(team.name, member.age.avg())
            .from(member)
            .join(member.team, team)
            .groupBy(team.name)
            .fetch();

    Tuple teamA = result.get(0);
    Tuple teamB = result.get(1);

    assertThat(teamA.get(team.name)).isEqualTo("teamA");
    assertThat(teamA.get(member.age.avg())).isEqualTo(15);
    assertThat(teamB.get(team.name)).isEqualTo("teamB");
    assertThat(teamB.get(member.age.avg())).isEqualTo(35);
}
```
ê·¸ë£¹í™”ëœ ê²°ê³¼ë¥¼ ì œí•œí•˜ë ¤ë©´ `having()`ì„ ì‚¬ìš©í•  ê²ƒ.

### `groupBy()`, `having()` ì˜ˆì‹œ
```text
.groupBy(item.price)
.having(item.price.gt(1_000))
```

## ì¡°ì¸ - ê¸°ë³¸ ì¡°ì¸
### ê¸°ë³¸ ì¡°ì¸
ì¡°ì¸ì˜ ê¸°ë³¸ ë¬¸ë²•ì€ ì²« ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì— ì¡°ì¸ ëŒ€ìƒì„ ì§€ì •í•˜ê³ , ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì— ë³„ì¹­(`alias`)ìœ¼ë¡œ ì‚¬ìš©í•  Q íƒ€ì…ì„ ì§€ì •í•˜ë©´ ëœë‹¤.

```text
join(ì¡°ì¸ ëŒ€ìƒ, ë³„ì¹­ìœ¼ë¡œ ì‚¬ìš©í•  Qíƒ€ì…)
```

#### ì‚¬ìš© ì˜ˆì‹œ
```java
/**
 * íŒ€ Aì— ì†Œì†ëœ ëª¨ë“  íšŒì›
 */
@Test
void join() throws Exception {
    QMember member = QMember.member;
    QTeam team = QTeam.team;

    List<Member> result = queryFactory
            .selectFrom(member)
            .join(member.team, team)
            .where(team.name.eq("teamA"))
            .fetch();

    assertThat(result)
            .extracting("username")
            .containsExactly("member1", "member2");
}
```
| ë©”ì†Œë“œ           | ì„¤ëª…                           |
|---------------|------------------------------|
| `join()`      | ë‚´ë¶€ ì¡°ì¸ (inner join)           |
| `innerJoin()` | ë‚´ë¶€ ì¡°ì¸ (inner join)           |
| `leftJoin()`  | ì™¼ìª½ ì™¸ë¶€ ì¡°ì¸ (left outer join)   |
| `rightJoin()` | ì˜¤ë¥¸ìª½ ì™¸ë¶€ ì¡°ì¸ (right outer join) |

- `JPQL`ì˜ `ON` ê¸°ëŠ¥ê³¼ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ `fetch` ì¡°ì¸ ì œê³µ â¡ï¸ ë‹¤ìŒ ON ì ˆì—ì„œ ì„¤ëª…

### ì„¸íƒ€ ì¡°ì¸
ì—°ê´€ê´€ê³„ê°€ ì—†ëŠ” í•„ë“œë¡œ ì¡°ì¸
```java
/**
 * íšŒì›ì˜ ì´ë¦„ì´ íŒ€ ì´ë¦„ê³¼ ê°™ì€ íšŒì› ì¡°íšŒ
 */
@Test
void theta_join() throws Exception {
    em.persist(new Member("teamA"));
    em.persist(new Member("teamB"));

    List<Member> result = queryFactory
            .select(member)
            .from(member, team)
            .where(member.username.eq(team.name))
            .fetch();

    assertThat(result)
            .extracting("username")
            .containsExactly("teamA", "teamB");
}
```
- from ì ˆì— ì—¬ëŸ¬ ì—”í‹°í‹°ë¥¼ ì„ íƒí•´ì„œ ì„¸íƒ€ ì¡°ì¸
- ì™¸ë¶€ ì¡°ì¸ ë¶ˆê°€ëŠ¥ â¡ï¸ë‹¤ìŒì— ì„¤ëª…í•  ì¡°ì¸ ONì„ ì‚¬ìš©í•˜ë©´ ì™¸ë¶€ ì¡°ì¸ì´ ê°€ëŠ¥í•˜ë‹¤.

## ì¡°ì¸ - ON ì ˆ
ON ì ˆì„ í™œìš©í•œ ì¡°ì¸ (JPA 2.1 ë¶€í„° ì§€ì›)
- ì¡°ì¸ ëŒ€ìƒ í•„í„°ë§
- ì—°ê´€ê´€ê³„ ì—†ì€ ì—”í‹°í‹° ì™¸ë¶€ ì¡°ì¸

### ì¡°ì¸ ëŒ€ìƒ í•„í„°ë§
ì˜ˆ) íšŒì›ê³¼ íŒ€ì„ ì¡°íšŒí•˜ë©´ì„œ, íŒ€ ì´ë¦„ì´ teamAì¸ íŒ€ë§Œ ì¡°ì¸, íšŒì›ì€ ëª¨ë‘ ì¡°íšŒ

#### ì˜ˆì‹œ ì½”ë“œ
```java
/**
 * JPQL: SELECT m, t FROM Member m LEFT JOIN m.team t on t.name = 'teamA'
 * SQL: SELECT m.*, t.* FROM Member m LEFT JOIN Team t ON m.TEAM_ID = t.id and t.name = 'teamA'
 */
@Test
void join_on_filtering() throws Exception {
    List<Tuple> result = queryFactory
            .select(member, team)
            .from(member)
            .leftJoin(member.team, team).on(team.name.eq("teamA"))
            .fetch();

    for (Tuple tuple : result) {
        System.out.println("tuple = " + tuple);
    }
}
```

#### ì‹¤í–‰ ê²°ê³¼
```text
tuple = [Member(id=1, username=member1, age=10), Team(id=1, name=teamA)]
tuple = [Member(id=2, username=member2, age=20), Team(id=1, name=teamA)]
tuple = [Member(id=3, username=member3, age=30), null]
tuple = [Member(id=4, username=member4, age=40), null]
```

> ğŸ€ ONì ˆì„ í™œìš©í•´ ì¡°ì¸ ëŒ€ìƒì„ í•„í„°ë§ í•  ë•Œ, ì™¸ë¶€ì¡°ì¸ì´ ì•„ë‹ˆë¼ ë‚´ë¶€ì¡°ì¸(INNER JOIN)ì„ ì‚¬ìš©í•˜ë©´,
> WHERE ì ˆì—ì„œ í•„í„°ë§í•˜ëŠ” ê²ƒê³¼ ê¸°ëŠ¥ì´ ë™ì¼í•˜ë‹¤. ë”°ë¼ì„œ ON ì ˆì„ í™œìš©í•œ ì¡°ì¸ ëŒ€ìƒ í•„í„°ë§ì„ ì‚¬ìš©í•  ë•Œ,
> ë‚´ë¶€ì¡°ì¸ì´ë©´ ìµìˆ™í•œ WHERE ì ˆë¡œ í•´ê²°í•˜ê³ , ì •ë§ ì™¸ë¶€ì¡°ì¸ì´ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì.

### ì—°ê´€ê´€ê³„ ì—†ëŠ” ì—”í‹°í‹° ì™¸ë¶€ ì¡°ì¸
ì˜ˆ) íšŒì›ì˜ ì´ë¦„ê³¼ íŒ€ì˜ ì´ë¦„ì´ ê°™ì€ ëŒ€ìƒ ì™¸ë¶€ ì¡°ì¸(íšŒì›ì˜ ì´ë¦„ê³¼ íŒ€ì˜ ì´ë¦„ì´ ê°™ì€ ê²½ìš°ì—ë§Œ íŒ€ë„ ì¡°ì¸, íšŒì›ì€ ëª¨ë‘ ì¡°íšŒ)

#### ì˜ˆì‹œ ì½”ë“œ
```java
/**
 * JPQL: SELECT m, t FROM Member m LEFT JOIN Team t ON m.username = t.name
 * SQL: SELECT m.*, t.* FROM Member m LEFT JOIN Team t ON m.username = t.name
 */
@Test
void join_on_no_relation() throws Exception {
    em.persist(new Member("teamA"));
    em.persist(new Member("teamB"));

    List<Tuple> result = queryFactory
            .select(member, team)
            .from(member)
            .leftJoin(team).on(member.username.eq(team.name))
            .fetch();

    for (Tuple tuple : result) {
        System.out.println("t=" + tuple);
    }
}
```

#### ì‹¤í–‰ ê²°ê³¼
```text
t=[Member(id=1, username=member1, age=10), null]
t=[Member(id=2, username=member2, age=20), null]
t=[Member(id=3, username=member3, age=30), null]
t=[Member(id=4, username=member4, age=40), null]
t=[Member(id=5, username=teamA, age=0), Team(id=1, name=teamA)]
t=[Member(id=6, username=teamB, age=0), Team(id=2, name=teamB)]
```

## ì¡°ì¸ - Fetch Join
Fetch Joinì€ SQLì—ì„œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì€ ì•„ë‹ˆë‹¤.  
SQL ì¡°ì¸ì„ í™œìš©í•´ì„œ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ SQL í•œ ë²ˆì— ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤.  
ì£¼ë¡œ ì„±ëŠ¥ ìµœì í™”ì— ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ë‹¤.

### Fetch Join ë¯¸ì ìš©
ì§€ì—°ë¡œë”©ìœ¼ë¡œ Member, Team SQL ì¿¼ë¦¬ ê°ê° ì‹¤í–‰
```java
@PersistenceUnit
EntityManagerFactory emf;

@Test
public void fetchJoinNo() throws Exception {
   em.flush();
   em.clear();

   Member findMember = queryFactory
           .selectFrom(member)
           .where(member.username.eq("member1"))
           .fetchOne();

   boolean loaded = emf.getPersistenceUnitUtil().isLoaded(findMember.getTeam());

   assertThat(loaded).as("í˜ì¹˜ ì¡°ì¸ ë¯¸ì ìš©").isFalse();
}
```

### Fetch Join ì ìš©
```java
@Test
void fetchJoinUser() throws Exception {
    em.flush();
    em.clear();

    Member findMember = queryFactory
            .selectFrom(member)
            .join(member.team, team).fetchJoin()
            .where(member.username.eq("member1"))
            .fetchOne();

    boolean loaded = emf.getPersistenceUnitUtil().isLoaded(findMember.getTeam());

    assertThat(loaded).as("í˜ì¹˜ ì¡°ì¸ ë¯¸ì ìš©").isTrue();
}
```
ì‚¬ìš© ë°©ë²•
- `join()`, `leftJoin()` ë“± ì¡°ì¸ ê¸°ëŠ¥ ë’¤ì— `fetchJoin()`ì„ ì¶”ê°€í•˜ë©´ ëœë‹¤.

> ğŸ€ Fetch Joinì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ JPA ê¸°ë³¸í¸ì´ë‚˜, í™œìš© 2í¸ì„ ì°¸ê³ í•˜ì

## ì„œë¸Œ ì¿¼ë¦¬
`com.querydsl.jpa.JPAExpressions` ì‚¬ìš©

### ì„œë¸Œ ì¿¼ë¦¬ eq ì‚¬ìš©
```java
/**
 * ë‚˜ì´ê°€ ê°€ì¥ ë§ì€ íšŒì› ì¡°íšŒ
 */
@Test
void subQuery() throws Exception {
    QMember memberSub = new QMember("memberSub");

    List<Member> result = queryFactory
            .selectFrom(member)
            .where(member.age.eq(
                    JPAExpressions
                            .select(memberSub.age.max())
                            .from(memberSub)
            ))
            .fetch();

    assertThat(result)
            .extracting("age")
            .containsExactly(40);
}
```

### ì„œë¸Œ ì¿¼ë¦¬ goe ì‚¬ìš©
```java
/**
 * ë‚˜ì´ê°€ í‰ê·  ë‚˜ì´ ì´ìƒì¸ íšŒì›
 */
@Test
void subQueryGoe() throws Exception {
    QMember memberSub = new QMember("memberSub");
    
    List<Member> result = queryFactory
            .selectFrom(member)
            .where(member.age.goe(
                    JPAExpressions
                            .select(memberSub.age.avg())
                            .from(memberSub)
            )) 
            .fetch();

    assertThat(result).extracting("age")
            .containsExactly(30, 40);
}
```

### ì„œë¸Œ ì¿¼ë¦¬ ì—¬ëŸ¬ ê±´ ì²˜ë¦¬ in ì‚¬ìš©
```java
/**
 * ì„œë¸Œì¿¼ë¦¬ ì—¬ëŸ¬ ê±´ ì²˜ë¦¬, in ì‚¬ìš©
 */
@Test
void subQueryIn() throws Exception {
   QMember memberSub = new QMember("memberSub");

   List<Member> result = queryFactory
           .selectFrom(member)
           .where(member.age.in(
                   JPAExpressions
                           .select(memberSub.age)
                           .from(memberSub)
                           .where(memberSub.age.gt(10))
           ))
           .fetch();

   assertThat(result).extracting("age")
           .containsExactly(20, 30, 40);
}
```

### SELECT ì ˆì— SubQuery
```java
List<Tuple> fetch = queryFactory
         .select(member.username,
                 JPAExpressions
                         .select(memberSub.age.avg())
                         .from(memberSub)
         ).from(member)
         .fetch();

for (Tuple tuple : fetch) {
    System.out.println("username = " + tuple.get(member.username));
    System.out.println("age = " +
    tuple.get(JPAExpressions.select(memberSub.age.avg())
        .from(memberSub)));
}
```

### static import í™œìš©
```java
import static com.querydsl.jpa.JPAExpressions.select;

List<Member> result = queryFactory
        .selectFrom(member)
        .where(member.age.eq(
                select(memberSub.age.max())
                        .from(memberSub)
        ))
        .fetch();
```


### FROMì ˆì˜ ì„œë¸Œì¿¼ë¦¬ í•œê³„
JPA JPQL ì„œë¹„ì¿¼ë¦¬ì˜ í•œê³„ì ìœ¼ë¡œ FROM ì ˆì˜ ì„œë¸Œì¿¼ë¦¬(ì¸ë¼ì¸ ë·°)ëŠ” ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤. ë‹¹ì—°íˆ QueryDSLë„ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤.
í•˜ì´ë²„ë„¤ì´íŠ¸ êµ¬í˜„ì²´ë¥¼ ì‚¬ìš©í•˜ë©´ SELECT ì ˆì˜ ì„œë¸Œì¿¼ë¦¬ëŠ” ì§€ì›ëœë‹¤.
QueryDSLë„ í•˜ì´ë²„ë„¤ì´íŠ¸ êµ¬í˜„ì²´ë¥¼ ì‚¬ìš©í•˜ë©´ SELECT ì ˆì˜ ì„œë¸Œì¿¼ë¦¬ë¥¼ ì§€ì›í•œë‹¤.

### FROMì ˆì˜ ì„œë¸Œì¿¼ë¦¬ í•´ê²° ë°©ì•ˆ
1. ì„œë¸Œì¿¼ë¦¬ë¥¼ JOIN ìœ¼ë¡œ ë³€ê²½í•œë‹¤. (ê°€ëŠ¥í•œ ìƒí™©ë„, ë¶ˆê°€ëŠ¥í•œ ìƒí™©ë„ ìˆë‹¤.)
2. ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¿¼ë¦¬ë¥¼ 2ë²ˆ ë¶„ë¦¬í•´ì„œ ì‹¤í–‰í•œë‹¤.
3. nativeSQLì„ ì‚¬ìš©í•œë‹¤.

## Case ë¬¸
SELECT, ì¡°ê±´ì ˆ(WHERE), ORDER BYì—ì„œ ì‚¬ìš© ê°€ëŠ¥
### ë‹¨ìˆœí•œ ì¡°ê±´
```java
List<String> result = queryFactory
        .select(member.age
                .when(10).then("ì—´ì‚´")
                .when(20).then("ìŠ¤ë¬´ì‚´")
                .otherwise("ê¸°íƒ€"))
        .from(member)
        .fetch();
```

### ë³µì¡í•œ ì¡°ê±´
```java
List<String> result = queryFactory
        .select(new CaseBuilder()
                .when(member.age.between(0, 20)).then("0~20ì‚´")
                .when(member.age.between(21, 30)).then("21~30ì‚´") 
                .otherwise("ê¸°íƒ€"))
        .from(member)
        .fetch();
```

### ORDER BYì—ì„œ CASEë¬¸ í•¨ê»˜ ì‚¬ìš©í•˜ê¸°
ì˜ˆë¥¼ ë“¤ì–´ì„œ ë‹¤ìŒê³¼ ê°™ì€ ì„ì˜ì˜ ìˆœì„œë¡œ íšŒì›ì„ ì¶œë ¥í•˜ê³  ì‹¶ë‹¤ë©´?
1. 0 ~ 30ì‚´ì´ ì•„ë‹Œ íšŒì›ì„ ê°€ì¥ ë¨¼ì € ì¶œë ¥
2. 0 ~ 20ì‚´ íšŒì› ì¶œë ¥
3. 21 ~ 30ì‚´ íšŒì› ì¶œë ¥
#### ì˜ˆì œ ì½”ë“œ
```java
NumberExpression<Integer> rankPath = new CaseBuilder()
        .when(member.age.between(0, 20)).then(2)
        .when(member.age.between(21, 30)).then(1)
        .otherwise(3);

List<Tuple> result = queryFactory
        .select(member.username, member.age, rankPath)
        .from(member)
        .orderBy(rankPath.desc())
        .fetch();

for (Tuple tuple : result) {
    String username = tuple.get(member.username);
    Integer age = tuple.get(member.age);
    Integer rank = tuple.get(rankPath);
    System.out.println("username = " + username + " age = " + age + " rank = " + rank); 
}
```

#### ì‹¤í–‰ ê²°ê³¼
```text
username = member4 age = 40 rank = 3
username = member1 age = 10 rank = 2
username = member2 age = 20 rank = 2
username = member3 age = 30 rank = 1
```

QueryDSLì€ ìë°” ì½”ë“œë¡œ ì‘ì„±í•˜ê¸° ë•Œë¬¸ì— `rankPath`ì²˜ëŸ¼ ë³µì¡í•œ ì¡°ê±´ì„ ë³€ìˆ˜ë¡œ ì„ ì–¸í•´ì„œ
`SELECT`ì ˆ, `ORDER BY`ì ˆì—ì„œ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

## ìƒìˆ˜, ë¬¸ì ë”í•˜ê¸°